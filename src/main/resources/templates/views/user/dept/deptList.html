

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>layuiAdmin 网站用户</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" href="/static/layui/layuiadmin/layui/css/layui.css" media="all">
  <link rel="stylesheet" href="/static/layui/layuiadmin/style/admin.css" media="all">
  <style>
    html, body {
      height: 100%;
      margin:0;padding:0;
      font-size: 12px;
    }
    div{
      -moz-box-sizing: border-box;  /*Firefox3.5+*/
      -webkit-box-sizing: border-box; /*Safari3.2+*/
      -o-box-sizing: border-box; /*Opera9.6*/
      -ms-box-sizing: border-box; /*IE8*/
      box-sizing: border-box; /*W3C标准(IE9+，Safari5.1+,Chrome10.0+,Opera10.6+都符合box-sizing的w3c标准语法)*/
    }
    .dHead {
      height:85px;
      width:100%;
      position: fixed;
      z-index:5;
      top:0;
      overflow-x: auto;
      padding: 10px;
    }
    .dBody {
      width:100%;
      overflow:auto;
      top:90px;
      position:absolute;
      z-index:10;
      bottom:5px;
    }
    .layui-btn-xstree {
      height: 35px;
      line-height: 35px;
      padding: 0px 5px;
      font-size: 12px;
    }
  </style>
</head>
<body>
<div style="height: 100%">
  <div class="dHead">
    <a class="layui-btn layui-btn-sm"  onclick="addParent();">添加</a>
    <a class="layui-btn layui-btn-primary layui-btn-xs layui-btn-xstree"  onclick="query()">query</a>
    <!--<a class="layui-btn layui-btn-primary layui-btn-xs layui-btn-xstree"  onclick="window.location.href='index.html';">刷新</a>
    <a class="layui-btn layui-btn-primary layui-btn-xs layui-btn-xstree"  onclick="reload()">reload</a>

    <a class="layui-btn layui-btn-primary layui-btn-xs layui-btn-xstree"  onclick="add(null);">新增一行</a>
    <a class="layui-btn layui-btn-primary layui-btn-xs layui-btn-xstree"  onclick="openorclose();">隐藏或打开香蕉节点</a>
    <a class="layui-btn layui-btn-primary layui-btn-xs layui-btn-xstree"  onclick="getCheckData();">获取选中行数据</a>
    <a class="layui-btn layui-btn-primary layui-btn-xs layui-btn-xstree"  onclick="getCheckLength();">获取选中数目</a>
    <a class="layui-btn layui-btn-primary layui-btn-xs layui-btn-xstree"  onclick="print();">打印缓存对象</a>-->
    <a class="layui-btn layui-btn-primary layui-btn-xs layui-btn-xstree"  onclick="openAll();">展开或折叠全部</a>
<!--    <a class="layui-btn layui-btn-primary layui-btn-xs layui-btn-xstree"  onclick="radioStatus();">获取单选数据</a>
    <a class="layui-btn layui-btn-primary layui-btn-xs layui-btn-xstree"  onclick="test();">test</a>-->
  </div>
  <div class="dBody">
    <table class="layui-hidden" id="treeTable" lay-filter="treeTable"></table>
  </div>
</div>
  <script src="/static/layui/layuiadmin/layui/layui.js"></script>
  <script src="/static/jquery/jquery-2.1.4.min.js" charset="utf-8"></script>
-
<script>
    var editObj=null,ptable=null,treeGrid=null,tableId='treeTable',layer=null;
    layui.config({
        base: '/static/layui/layuiadmin/plugins/'
    }).extend({
        treeGrid:'treeGrid'
    }).use(['jquery','treeGrid','layer',], function(){
        var $=layui.jquery;
        treeGrid = layui.treeGrid;//很重要
        layer=layui.layer;
        ptable=treeGrid.render({
            id:tableId
            ,elem: '#'+tableId
            ,url:'/sysdept/getTreeData'
            ,cellMinWidth: 100
            ,idField:'id'//必須字段
            ,treeId:'id'//树形id字段名称
            ,treeUpId:'pId'//树形父id字段名称
            ,treeShowName:'name'//以树形式显示的字段
            ,heightRemove:[".dHead",10]//不计算的高度,表格设定的是固定高度，此项不生效
            ,height:'100%'
            ,isFilter:false
            ,iconOpen:true//是否显示图标【默认显示】
            ,isOpenDefault:true//节点默认是展开还是折叠【默认展开】
            ,loading:true
            ,method:'post'
            ,cols: [[
                {type:'numbers'}
                ,{type:'radio'}
                ,{type:'checkbox',sort:true}
                ,{field:'name', width:300, title: '部门名称',edit:'text',sort:true}
                ,{field:'sort',width:100, title: '排序',sort:true}
                ,{field:'isdel', title: '状态',sort:true}
                ,{width:150,title: '操作', align:'center'/*toolbar: '#barDemo'*/
                    ,templet: function(d){
                        var html='';
                        var addBtn='<a class="layui-btn layui-btn-sm layui-btn-xs" lay-event="add">添加</a>';
                        var editBtn='<a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="edit">修改</a>';
                        var delBtn='<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>';
                        return addBtn+editBtn+delBtn;
                    }
                }
            ]]
            ,isPage:false
            ,parseData:function (res) {//数据加载后回调
                return res;
            }
            ,onClickRow:function (index, o) {
           //     console.log(index,o,"单击！");
            }
            ,onDblClickRow:function (index, o) {
              //  console.log(index,o,"双击");
            }
        });

        treeGrid.on('tool('+tableId+')',function (obj) {
            var id = obj.data.id;
            if(obj.event === 'del'){//删除行
                del(id);
            }else if(obj.event==="add"){  //添加行
                deptAdd(id);
            }else if(obj.event==="edit"){ //修改
                deptEdit(id);
            }
        });
    });



    function del(id) {
        layer.confirm("你确定删除数据吗？如果存在下级节点则一并删除，此操作不能撤销！", {icon: 3, title:'提示'},
            function(index){//确定回调
                $.post("/sysdept/deleteById",{id:id},function (res){
                    layer.msg("删除部门成功");
                });
                query();
                //reload();
                layer.close(index);
            },function (index) {//取消回调
                layer.close(index);
            }
        );
    }


    function deptAdd(id){
        layer.open({
            type: 2
            ,title: '增加部门信息'
            ,content: '/sysdept/getByIdAdd?id='+id
            //    ,maxmin: true
            ,area: ['450px', '400px']
            ,btn: ['确定', '取消']
            ,yes: function(index, layero){
                var iframeWindow = window['layui-layer-iframe'+ index]
                    ,submitID = 'deptSubmit'
                    ,submit = layero.find('iframe').contents().find('#'+ submitID);
                //监听提交
                iframeWindow.layui.form.on('submit('+ submitID +')', function(data){
                    var field = data.field; //获取提交的字段
                    field.pid = id;
                    $.ajax({
                       url : '/sysdept/insert',
                       type : 'post',
                       dataType : 'json',
                       data: field,
                       success : function (res){
                         layer.msg("增加部门成功");
                         query();
                         // reload();
                         layer.close(index); //关闭弹层
                        }
                     })
                });
                submit.trigger('click');
            }
        });
    }


    function deptEdit(id){
        layer.open({
            type: 2
            ,title: '修改部门信息'
            ,content: '/sysdept/getByIdEdit?id='+id
            //    ,maxmin: true
            ,area: ['450px', '400px']
            ,btn: ['确定', '取消']
            ,yes: function(index, layero){
                var iframeWindow = window['layui-layer-iframe'+ index]
                    ,submitID = 'deptUpdate'
                    ,submit = layero.find('iframe').contents().find('#'+ submitID);
                //监听提交
                iframeWindow.layui.form.on('submit('+ submitID +')', function(data){
                    var field = data.field; //获取提交的字段
                  $.ajax({
                   url : '/sysdept/update',
                   type : 'post',
                   dataType : 'json',
                   data: field,
                   success : function (res){
                   layer.msg("修改部门成功");
                   query();
                   //reload();
                   layer.close(index); //关闭弹层
                   }
                   })
                });
                submit.trigger('click');
            }
        });
    }


    function addParent(){
        layer.open({
            type: 2
            ,title: '新增部门信息'
            ,content: 'add.html'
            //    ,maxmin: true
            ,area: ['450px', '400px']
            ,btn: ['确定', '取消']
            ,yes: function(index, layero){
                var iframeWindow = window['layui-layer-iframe'+ index]
                    ,submitID = 'addSubmit'
                    ,submit = layero.find('iframe').contents().find('#'+ submitID);
                //监听提交
                iframeWindow.layui.form.on('submit('+ submitID +')', function(data){
                    var field = data.field; //获取提交的字段
                    field.pid = 0;
                    $.ajax({
                        url : '/sysdept/insert',
                        type : 'post',
                        dataType : 'json',
                        data: field,
                        success : function (res){
                            layer.msg("新增部门成功");
                            query();
                            //reload();
                            layer.close(index); //关闭弹层
                        }
                    })
                });
                submit.trigger('click');
            }
        });
    }

    function print() {
        console.log(treeGrid.cache[tableId]);
        var loadIndex=layer.msg("对象已打印，按F12，在控制台查看！", {
            time:3000
            ,offset: 'auto'//顶部
            ,shade: 0
        });
    }

    function openorclose() {
        var map=treeGrid.getDataMap(tableId);
        var o= map['102'];
        treeGrid.treeNodeOpen(tableId,o,!o[treeGrid.config.cols.isOpen]);
    }


    function openAll() {
        var treedata=treeGrid.getDataTreeList(tableId);
        treeGrid.treeOpenAll(tableId,!treedata[0][treeGrid.config.cols.isOpen]);
    }

    function getCheckData() {
        var checkStatus = treeGrid.checkStatus(tableId)
            ,data = checkStatus.data;
        layer.alert(JSON.stringify(data));
    }
    function radioStatus() {
        var data = treeGrid.radioStatus(tableId)
        layer.alert(JSON.stringify(data));
    }
    function getCheckLength() {
        var checkStatus = treeGrid.checkStatus(tableId)
            ,data = checkStatus.data;
        layer.msg('选中了：'+ data.length + ' 个');
    }

    function reload() {
        treeGrid.reload(tableId,{
            page:{
                curr:1
            }
        });
    }
    function query() {
        treeGrid.query(tableId,{
            where:{
                name:'sdfsdfsdf'
            }
        });
    }

    function test() {
        console.log(treeGrid.cache[tableId],treeGrid.getClass(tableId));


      /*var map=treeGrid.getDataMap(tableId);
       var o= map['102'];
       o.name="更新";
       treeGrid.updateRow(tableId,o);*/
    }
</script>







</body>
</html>
